{% extends "event/read_base.html" %}
{% import 'macros/form.html' as form %}

{% block primary_content_inner %}
    {% block events_search_form %}

        {% snippet 'snippets/search_form.html',     fields=[('category', c.category.lower()), ('include_expired', c.include_expired_events)],
                                            type=(c.category.lower() or 'event'),
                                            query=c.q,
                                            count=c.events_count,
                                            placeholder=_('Search Events...'),
                                            show_empty=request.params,
                                            no_bottom_border=true
        %}

        Displaying the next <b>{{c.rows}}</b> upcoming events. <br>Click to display the next
            {% set href = h.remove_url_param('rows', replace=50) %} <a href={{href}}>50</a> |
            {% set href = h.remove_url_param('rows', replace=150) %} <a href={{href}}>150</a> |
            {% set href = h.remove_url_param('rows', replace=5000) %} <a href={{href}}>All</a> upcoming events

    {% endblock %}
    {% block events_display %}
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
        <script>
            var map;
            function initialize() {
                /* center on first event. Map center and zoom will reconfigure later (fitbounds method)*/
                  var mapOptions = {
                        zoom: 15,
                        center: new google.maps.LatLng(events[0][0], events[0][1])
                    };
                    var map = new google.maps.Map(document.getElementById('map-canvas'),mapOptions);

                    setEvents(map, events);
            }

            var events = [];
            {% for event in c.events %}
                var event_display = "<a href='{{event.get('link')}}' target='_blank'>" +
                        "<h3>{{event.get('title') }}</h3></a>" +
                        "<b>Date: </b>{{ event.get('succinct_dates')}}<br>" +
                        "<b>Location:</b> {{ event.get('city')}}, {{ event.get('country')}}<br>" +
                        "<b>Provider:</b> {{ event.get('provider', 'Not specified') }}<br>"
                events.push([
                    {{ event.get('latitude') }},
                    {{ event.get('longitude') }},
                    event_display
                ]);
            {% endfor %}


            function setEvents(map, events){

                var bounds = new google.maps.LatLngBounds();
                var infowindow = new google.maps.InfoWindow({content: "Content String"});
                for (var i = 0; i < events.length; i++) {
                    var new_marker = createMarker(map, events[i], infowindow)
                    bounds.extend(new_marker.position);
                }
                map.fitBounds(bounds);
            }

            function createMarker(map, event, infowindow){
                var position = new google.maps.LatLng(event[0], event[1]);
                var marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: 'wakka'
                });
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent(event[2]);
                    infowindow.open(map,marker);
                });
                return marker;
            }

            google.maps.event.addDomListener(window, 'load', initialize);
        </script>
            <div id="map-canvas" style="background-color: transparent; height: 750px;"></div>
    {% endblock %}

{% endblock %}
